{% extends "base.html" %} {% block title %}shrtn{% endblock %} {% block head %}
<style>
  #inputs {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  #output {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;

    * {
      text-align: center;
    }

    > * {
      &:only-child {
        margin: 0.5rem 0;
      }

      &:first-child:not(:only-child) {
        margin: 0.5rem 0 0 0;
      }

      &:last-child:not(:only-child) {
        margin: 0 0 0.5rem 0;
      }
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const submit = document.getElementById("submit");
    const output = document.getElementById("output");
    const targetInput = document.getElementById("target");
    const shortInput = document.getElementById("short");

    submit.addEventListener("click", async () => {
      const raw = targetInput.value.trim();

      if (!raw) {
        output.innerHTML = "<p>please provide an url to shorten.</p>";
        return;
      }

      const normalised = normaliseURL(raw);
      if (!normalised) {
        output.innerHTML = "<p>please provide a valid url.</p>";
        return;
      }

      submit.disabled = true;
      output.innerHTML = "<p>shortening… ꩜</p>";

      const { success, message, data } = await shorten(
        normalised,
        shortInput.value.trim(),
      );

      if (!success)
        output.innerHTML = `<p>${message ?? "something went wrong."}</p>`;
      else {
        const url = `${window.location.origin}/${data.short}`;
        output.innerHTML = `<a href="${url}" target="_blank" rel="noopener">${url}</a><p>${data.token}</>`;
      }

      submit.disabled = false;
    });

    function normaliseURL(input) {
      try {
        const parsed = new URL(input.trim());
        return parsed.toString();
      } catch {
        return null;
      }
    }
  });

  async function shorten(target, short) {
    const response = await fetch("/api/urls", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ target, short }),
    });

    return response.json().catch(() => ({}));
  }
</script>
{% endblock %} {% block body %}
<p>a minimal url shortener.</p>

<section id="inputs">
  <input id="target" type="text" placeholder="url" required />
  <input id="short" type="text" placeholder="slug (optional)" />
  <button type="button" id="submit">shorten</button>
</section>

<div id="output"><p>nothing has been shortened yet.</p></div>
{% endblock %}
